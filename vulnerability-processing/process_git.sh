#!/bin/bash 
# 
# @summary Script for downloading git and processing it by using show_ast.js
# @author Vojtěch Randýsek, xrandy00@vutbr.cz
# 
# Created at     : 2022-05-06 22:22:02 
# Last modified  : 2022-05-07 11:05:21
# 

realpath() {
    [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

rm -rf tmp
rm -rf fixed
rm -rf broken

mkdir tmp
mkdir fixed
mkdir broken

# clone the git repo
git clone $2 tmp

cd tmp

# checkout commit of the fix
git fetch
git checkout $1

# copy all the files to "fixed" folder
for path in `git diff-tree --no-commit-id --name-only -r $1`;
do 
    if [[ $path == *.js ]] && [[ $path != *test* ]]
    then mv $path ../fixed
    fi
done

# checkout previous commit
git checkout $1^1

# move all the files to "broken"folder
for path in `git diff-tree --no-commit-id --name-only -r $1`;
do 
    if [[ $path == *.js ]] && [[ $path != *test* ]]
    then mv $path ../broken
    fi
done

cd ..
rm -rf tmp

# go over broken files, find their mirror in fixed folder and send both with metadata to show_ast script
for filename in broken/*; do
    node show_ast "$(realpath $filename)" "$(realpath fixed/$(basename $filename))" "$3" "$4" "$5" "$6"
done


